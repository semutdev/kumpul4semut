---
/**
 * Giscus Comments Component
 *
 * To use this component, you need to:
 * 1. Enable GitHub Discussions on your repository
 * 2. Install the Giscus app: https://github.com/apps/giscus
 * 3. Visit https://giscus.app to get your configuration
 * 4. Update the data-repo, data-repo-id, data-category, and data-category-id below
 */

export interface Props {
  repo?: string;
  repoId?: string;
  category?: string;
  categoryId?: string;
}

const {
  repo = "semutdev/kumpul4semut", // Replace with your repo
  repoId = "R_kgDOP67rGw", // Replace with your repo ID
  category = "General", // Replace with your discussion category
  categoryId = "DIC_kwDOP67rG84Cz_9z" // Replace with your category ID
} = Astro.props;
---

<div class="comments-section mt-12 pt-8 border-t border-gray-200 dark:border-gray-700">
  <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">Comments</h2>

  <div class="giscus-wrapper"></div>
</div>

<script
  define:vars={{ repo, repoId, category, categoryId }}
  is:inline
>
  // Load Giscus comments
  function loadComments() {
    const commentsWrapper = document.querySelector('.giscus-wrapper');
    if (!commentsWrapper) return;

    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', repo);
    script.setAttribute('data-repo-id', repoId);
    script.setAttribute('data-category', category);
    script.setAttribute('data-category-id', categoryId);
    script.setAttribute('data-mapping', 'pathname');
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'top');

    // Theme based on dark mode
    const theme = document.documentElement.classList.contains('dark')
      ? 'dark'
      : 'light';
    script.setAttribute('data-theme', theme);

    script.setAttribute('data-lang', 'en');
    script.setAttribute('data-loading', 'lazy');
    script.crossOrigin = 'anonymous';
    script.async = true;

    commentsWrapper.appendChild(script);
  }

  // Lazy load comments using Intersection Observer
  if (typeof IntersectionObserver !== 'undefined') {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          loadComments();
          observer.disconnect();
        }
      });
    }, {
      rootMargin: '200px',
    });

    const commentsSection = document.querySelector('.comments-section');
    if (commentsSection) {
      observer.observe(commentsSection);
    }
  } else {
    // Fallback for browsers without IntersectionObserver
    loadComments();
  }

  // Listen for theme changes and update Giscus theme
  document.addEventListener('DOMContentLoaded', () => {
    const themeToggle = document.getElementById('theme-toggle');
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTimeout(() => {
          const iframe = document.querySelector('iframe.giscus-frame');
          if (iframe) {
            const theme = document.documentElement.classList.contains('dark')
              ? 'dark'
              : 'light';

            iframe.contentWindow?.postMessage(
              {
                giscus: {
                  setConfig: {
                    theme: theme
                  }
                }
              },
              'https://giscus.app'
            );
          }
        }, 100);
      });
    }
  });
</script>

<style>
  .giscus-wrapper {
    min-height: 200px;
  }
</style>
