---
import { getCollection } from "astro:content";
import { filterDrafts } from "../content/config";

const allPosts = await getCollection("blog");
const posts = filterDrafts(allPosts);

const searchData = posts.map((post) => ({
    title: post.data.title,
    description: post.data.description,
    slug: post.slug,
    tags: post.data.tags || [],
}));
---

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-[9999] hidden">
    <!-- Modal container - centered in viewport -->
    <div class="fixed inset-0 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="modal-content relative w-full max-w-2xl bg-white dark:bg-gray-900 rounded-2xl shadow-2xl transform transition-all" id="search-modal-content">
            <!-- Modal Header with Close Button -->
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <div class="flex items-center gap-2 text-lg font-semibold text-gray-900 dark:text-gray-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <span>Pencarian Catatan</span>
                </div>
                <button
                    type="button"
                    id="search-close-btn"
                    class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors"
                    aria-label="Tutup pencarian"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <!-- Search Input -->
                <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                    <div class="relative">
                        <svg
                            class="absolute left-3 top-3.5 w-5 h-5 text-gray-400"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                            ></path>
                        </svg>
                        <input
                            type="text"
                            id="search-input"
                            placeholder="Cari catatan..."
                            class="w-full pl-10 pr-4 py-3 bg-gray-50 dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 dark:text-gray-100"
                            autocomplete="off"
                        />
                    </div>
                </div>

                <!-- Search Results -->
                <div id="search-results" class="max-h-96 overflow-y-auto p-4">
                    <div id="results-list"></div>
                    <div
                        id="no-results"
                        class="hidden text-center py-8 text-gray-500 dark:text-gray-400"
                    >
                        ðŸ˜” Tidak ada catatan yang ditemukan
                    </div>
                </div>

                <!-- Search Help -->
                <div
                    class="p-4 border-t border-gray-200 dark:border-gray-700 text-sm text-gray-500 dark:text-gray-400"
                >
                    <div class="flex items-center justify-between">
                        <span>Ketik untuk mencari</span>
                        <kbd
                            class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs"
                            >ESC untuk tutup</kbd
                        >
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script define:vars={{ searchData }} is:inline>
    // Wait for DOM to be ready
    function initSearch() {
        // Search functionality
        const searchButtons = document.querySelectorAll(
            ".search-button-trigger",
        );
        const searchModal = document.getElementById("search-modal");
        const searchBackdrop = document.getElementById("search-backdrop");
        const searchInput = document.getElementById("search-input");
        const resultsList = document.getElementById("results-list");
        const noResults = document.getElementById("no-results");

        if (!searchModal) {
            console.error("Search modal not found");
            return;
        }

        function openSearch() {
            if (searchModal) {
                searchModal.classList.remove("hidden");
                if (searchInput) {
                    setTimeout(() => searchInput.focus(), 100);
                }
            }
        }

        function closeSearch() {
            if (searchModal) {
                searchModal.classList.add("hidden");
            }
            if (searchInput) {
                searchInput.value = "";
            }
            if (resultsList) {
                resultsList.innerHTML = "";
            }
            if (noResults) {
                noResults.classList.add("hidden");
            }
        }

        function search(query) {
            if (!query.trim()) {
                if (resultsList) resultsList.innerHTML = "";
                if (noResults) noResults.classList.add("hidden");
                return;
            }

            const lowerQuery = query.toLowerCase();
            const results = searchData.filter(
                (post) =>
                    post.title.toLowerCase().includes(lowerQuery) ||
                    post.description.toLowerCase().includes(lowerQuery) ||
                    post.tags.some((tag) =>
                        tag.toLowerCase().includes(lowerQuery),
                    ),
            );

            if (results.length === 0) {
                if (resultsList) resultsList.innerHTML = "";
                if (noResults) noResults.classList.remove("hidden");
                return;
            }

            if (noResults) noResults.classList.add("hidden");

            if (resultsList) {
                resultsList.innerHTML = results
                    .map(
                        (post) => `
          <a href="/blog/${post.slug}/" class="block p-4 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg transition-colors border border-transparent hover:border-blue-500 mb-2 no-underline">
            <h3 class="font-semibold text-gray-900 dark:text-gray-100 mb-1 mt-0">${post.title}</h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2 mb-0">${post.description}</p>
            ${
                post.tags.length > 0
                    ? `
              <div class="flex gap-2 mt-2">
                ${post.tags
                    .slice(0, 3)
                    .map(
                        (tag) =>
                            `<span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-800 text-gray-600 dark:text-gray-300 rounded border border-gray-200 dark:border-gray-700">${tag}</span>`,
                    )
                    .join("")}
              </div>
            `
                    : ""
            }
          </a>
        `,
                    )
                    .join("");
            }
        }

        // Event listeners
        searchButtons.forEach((btn) => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                openSearch();
            });
        });

        // Close button functionality
        const searchCloseBtn = document.getElementById("search-close-btn");
        if (searchCloseBtn) {
            searchCloseBtn.addEventListener("click", (e) => {
                e.preventDefault();
                closeSearch();
            });

            // Touch support for mobile
            searchCloseBtn.addEventListener("touchend", (e) => {
                e.preventDefault();
                closeSearch();
            });
        }

        // Optional: Close when clicking outside the modal content
        const modalContent = document.getElementById("search-modal-content");
        if (modalContent) {
            modalContent.addEventListener("click", (e) => {
                e.stopPropagation();
            });
        }

        // Add backdrop click to close (optional - works on desktop)
        searchModal.addEventListener("click", (e) => {
            if (e.target === searchModal) {
                closeSearch();
            }
        });

        if (searchInput) {
            searchInput.addEventListener("input", (e) => {
                search(e.target.value);
            });
        }

        // Keyboard shortcuts
        document.addEventListener("keydown", (e) => {
            // Cmd/Ctrl + K to open search
            if ((e.metaKey || e.ctrlKey) && e.key === "k") {
                e.preventDefault();
                openSearch();
            }

            // ESC to close search
            if (e.key === "Escape") {
                closeSearch();
            }
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initSearch);
    } else {
        initSearch();
    }
</script>

<style>
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    /* Search modal styles */
    #search-modal {
        cursor: default;
    }

    .modal-content {
        cursor: default;
        -webkit-tap-highlight-color: transparent;
        max-height: 90vh;
        overflow-y: auto;
    }

    /* Close button styles */
    #search-close-btn {
        -webkit-tap-highlight-color: transparent;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .modal-content {
            max-height: 95vh;
            margin: 1rem;
            width: calc(100% - 2rem);
        }

        #search-close-btn {
            min-width: 48px;
            min-height: 48px;
        }
    }
</style>
